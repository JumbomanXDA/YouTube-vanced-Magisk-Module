#!/system/bin/sh
# Disable Play store updates for vanced YouTube

LDB="/data/data/com.android.vending/databases/library.db"
LADB="/data/data/com.android.vending/databases/localappstate.db"

GET_LDB=`sqlite3 $LDB "SELECT doc_type,doc_id FROM ownership" | grep com.google.android.youtube | head -n 1 | grep -o 25`
GET_LADB=`sqlite3 $LADB "SELECT auto_update,package_name FROM appstate" | grep com.google.android.youtube | head -n 1 | grep -o 2`

# Keep Log for ~4 days
N=$(cat /data/detach_YT.log | wc -l)
if [ "$N" -ge "100" ]; then
	rm -rf /data/detach_YT.log
fi

if [[ "$GET_LDB" != "25" || "$GET_LADB" != "2" ]]; then
	# Force stop Play store
	am force-stop com.android.vending > /dev/null 2>&1
	
	sqlite3 $LDB "UPDATE ownership SET doc_type = '25' where doc_id = 'com.google.android.youtube'"
	sqlite3 $LADB "UPDATE appstate SET auto_update = '2' where package_name = 'com.google.android.youtube'"
	
	# Disable Fallback broadcast
	pm disable "com.android.vending/com.google.android.finsky.scheduler.FallbackReceiver" > /dev/null 2>&1
	cmd appops set com.android.vending RUN_IN_BACKGROUND ignore > /dev/null 2>&1
	
	# Log
	echo "$(date) - YouTube vanced successfully detached from play store" >> /data/detach_YT.log
else
	echo "$(date) - YouTube vanced already detached. No need to run detach script" >> /data/detach_YT.log
fi

