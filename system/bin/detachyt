#!/system/bin/sh
# Detach script - Disable Play store updates for vanced YouTube

# Expansion
LOG=/data/detach_YT.log
PS=com.android.vending
LDB="/data/data/$PS/databases/library.db"
LADB="/data/data/$PS/databases/localappstate.db"
YT=com.google.android.youtube

GET_LDB=`sqlite3 $LDB "SELECT doc_type,doc_id FROM ownership" | grep $YT | head -n 1 | grep -o 25`
GET_LADB=`sqlite3 $LADB "SELECT auto_update,package_name FROM appstate" | grep $YT | head -n 1 | grep -o 2`

# Keep Log for ~7 days
N=$(cat $LOG | wc -l)
if [ "$N" -ge "100" ]; then
	rm -rf $LOG
fi

if [[ "$GET_LDB" != "25" || "$GET_LADB" != "2" ]]; then
	# Force Disable Play store
	# I find that sometimes "am force-stop" command not working
	pm disable $PS > /dev/null 2>&1
	
	# Update database
	sqlite3 $LDB "UPDATE ownership SET doc_type = '25' where doc_id = '$YT'"
	sqlite3 $LADB "UPDATE appstate SET auto_update = '2' where package_name = '$YT'"
	
	# Delete cache for play store
	rm -rf /data/data/$PS/cache/*
	
	# Re-enable Play store
	pm enable $PS > /dev/null 2>&1

	# Log
	echo "$(date) - YouTube vanced successfully detached from play store" >> $LOG
else
	echo "$(date) - YouTube vanced already detached. No need to run detach script" >> $LOG
fi

